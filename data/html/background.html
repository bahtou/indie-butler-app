<script src="../../lib/vendor/socket.io.js"></script>
<script src="../../lib/vendor/underscore-min.js"></script>
<script src="../../lib/vendor/IDBStore.js"></script>
<script src="../../lib/vendor/mustache.js"></script>
<script src="../../lib/requests/get.js"></script>
<script>

// Store
var socStore = new IDBStore();

var relay = localStorage.getItem("relay");
var domain = localStorage.getItem("domain");
var ioOptions = {
  'max reconnection attempts' : 100000,
  'reconnection limit'        : 1000 * 60 * 10,
  'reconnect'                 : true,
};

// Listening to external (relay) requests
if(relay) {
  console.log('Butler up!', relay);
  var socket = io.connect(relay, ioOptions);
  socket.on('connect', function() {
    socket.emit('register', domain);
    socket.on('get', function (request, fn) {
      console.log(request);
      get(request, fn);
    });
    console.log('connected as', domain);
  });
  socket.on('disconnect', function() {
    console.log('disconnected');
  });
}


// Internal events
chrome.extension.onRequest.addListener(function(activity, sender, fn) {
  if(activity.get) {
    get(activity.get, fn);
  }
  else {
    if(typeof(activity.id) === 'undefined') {
      activity.id = Math.random().toString(36).substring(8);
    }
    socStore.put(activity);
  }
});


</script>
